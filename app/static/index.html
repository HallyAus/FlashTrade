<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashTrade</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, monospace;
            background: #0a0e17;
            color: #e1e4e8;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid #1e2836;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #58a6ff;
        }

        .logo span { color: #f0883e; }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-badge.online {
            background: rgba(46, 160, 67, 0.15);
            color: #3fb950;
            border: 1px solid rgba(46, 160, 67, 0.3);
        }

        .status-badge.offline {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }

        .pulse {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #3fb950;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* Cards grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            margin-top: 24px;
        }

        .card {
            background: #161b22;
            border: 1px solid #21262d;
            border-radius: 8px;
            padding: 20px;
        }

        .card-header {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #8b949e;
            margin-bottom: 12px;
        }

        .card-value {
            font-size: 32px;
            font-weight: 700;
            color: #e1e4e8;
        }

        .card-value.green { color: #3fb950; }
        .card-value.blue { color: #58a6ff; }
        .card-value.orange { color: #f0883e; }

        .card-sub {
            font-size: 13px;
            color: #8b949e;
            margin-top: 4px;
        }

        /* Markets table */
        .markets-card {
            grid-column: 1 / -1;
        }

        .market-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .market-table th {
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #8b949e;
            padding: 8px 12px;
            border-bottom: 1px solid #21262d;
        }

        .market-table td {
            padding: 12px;
            border-bottom: 1px solid #21262d;
            font-size: 14px;
        }

        .market-table tr:last-child td { border-bottom: none; }

        .market-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .market-status.ready {
            background: rgba(46, 160, 67, 0.15);
            color: #3fb950;
        }

        .market-status.pending {
            background: rgba(187, 128, 9, 0.15);
            color: #d29922;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .dot.green { background: #3fb950; }
        .dot.yellow { background: #d29922; }

        /* System log */
        .log-card {
            grid-column: 1 / -1;
        }

        .log-entries {
            margin-top: 12px;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 13px;
            line-height: 1.8;
        }

        .log-entry {
            display: flex;
            gap: 12px;
            padding: 4px 0;
        }

        .log-time { color: #484f58; min-width: 85px; }
        .log-level { min-width: 50px; font-weight: 600; }
        .log-level.info { color: #58a6ff; }
        .log-level.ok { color: #3fb950; }
        .log-level.warn { color: #d29922; }
        .log-msg { color: #8b949e; }

        /* Footer */
        .footer {
            margin-top: 40px;
            padding: 20px 0;
            border-top: 1px solid #1e2836;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #484f58;
        }

        .footer a { color: #58a6ff; text-decoration: none; }
        .footer a:hover { text-decoration: underline; }

        /* Kill switch */
        .kill-btn {
            background: rgba(248, 81, 73, 0.1);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
        }

        .kill-btn:hover {
            background: rgba(248, 81, 73, 0.2);
        }

        /* Live Prices */
        .prices-card { grid-column: 1 / -1; }

        .price-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .price-card {
            background: #0d1117;
            border: 1px solid #21262d;
            border-radius: 6px;
            padding: 14px;
        }

        .price-symbol {
            font-size: 14px;
            font-weight: 700;
            color: #e1e4e8;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .price-tag.crypto { background: rgba(136, 87, 229, 0.2); color: #a371f7; }
        .price-tag.asx { background: rgba(46, 160, 67, 0.2); color: #3fb950; }
        .price-tag.us { background: rgba(88, 166, 255, 0.2); color: #58a6ff; }

        .price-value {
            font-size: 22px;
            font-weight: 700;
            margin: 8px 0 4px;
            color: #e1e4e8;
        }

        .price-change { font-size: 13px; font-weight: 600; }
        .price-change.up { color: #3fb950; }
        .price-change.down { color: #f85149; }
        .price-change.flat { color: #8b949e; }

        .price-meta { font-size: 11px; color: #484f58; margin-top: 6px; }

        .price-error {
            color: #d29922;
            font-size: 12px;
            padding: 8px;
            background: rgba(187, 128, 9, 0.1);
            border-radius: 4px;
            margin-top: 8px;
        }

        /* Market session status */
        .session-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .session-card {
            background: #0d1117;
            border: 1px solid #21262d;
            border-radius: 6px;
            padding: 14px;
            text-align: center;
        }

        .session-market { font-size: 14px; font-weight: 700; margin-bottom: 6px; }
        .session-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .session-badge.open { background: rgba(46, 160, 67, 0.15); color: #3fb950; }
        .session-badge.closed { background: rgba(248, 81, 73, 0.15); color: #f85149; }
        .session-detail { font-size: 11px; color: #484f58; margin-top: 6px; }

        /* Data health */
        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .health-item {
            background: #0d1117;
            border: 1px solid #21262d;
            border-radius: 6px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .health-label { font-size: 13px; color: #e1e4e8; }
        .health-label small { color: #484f58; font-size: 11px; }
        .health-stat { font-size: 12px; font-weight: 600; }
        .health-stat.ok { color: #3fb950; }
        .health-stat.warn { color: #d29922; }
        .health-stat.error { color: #f85149; }
        .health-summary {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            font-size: 13px;
        }
        .health-summary span { color: #8b949e; }

        /* Trade form */
        .trade-card { grid-column: 1 / -1; }

        .trade-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .trade-form label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #8b949e;
            display: block;
            margin-bottom: 4px;
        }

        .trade-form select, .trade-form input {
            width: 100%;
            background: #0d1117;
            border: 1px solid #21262d;
            color: #e1e4e8;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .trade-form select:focus, .trade-form input:focus {
            border-color: #58a6ff;
            outline: none;
        }

        .trade-actions {
            display: flex;
            gap: 8px;
            margin-top: 14px;
        }

        .btn-buy, .btn-sell {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
        }

        .btn-buy {
            background: rgba(46, 160, 67, 0.15);
            color: #3fb950;
            border: 1px solid rgba(46, 160, 67, 0.3);
        }
        .btn-buy:hover { background: rgba(46, 160, 67, 0.25); }

        .btn-sell {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.3);
        }
        .btn-sell:hover { background: rgba(248, 81, 73, 0.25); }

        .trade-result {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            display: none;
        }
        .trade-result.success { display: block; background: rgba(46,160,67,0.1); color: #3fb950; }
        .trade-result.error { display: block; background: rgba(248,81,73,0.1); color: #f85149; }

        /* Positions table */
        .positions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 13px;
        }
        .positions-table th {
            text-align: left;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #8b949e;
            padding: 8px;
            border-bottom: 1px solid #21262d;
        }
        .positions-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #161b22;
        }
        .positions-table .pnl-positive { color: #3fb950; }
        .positions-table .pnl-negative { color: #f85149; }

        /* Chart */
        .chart-card { grid-column: 1 / -1; }

        .chart-controls {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .chart-controls select, .chart-controls button {
            background: #0d1117;
            border: 1px solid #21262d;
            color: #e1e4e8;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
        }

        .chart-controls select:focus { border-color: #58a6ff; outline: none; }

        .tf-btn { transition: background 0.15s; }
        .tf-btn.active {
            background: rgba(88, 166, 255, 0.15);
            border-color: #58a6ff;
            color: #58a6ff;
        }
        .tf-btn:hover { background: #161b22; }

        #chart-container {
            width: 100%;
            height: 400px;
            border-radius: 6px;
            overflow: hidden;
        }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">Flash<span>Trade</span></div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <button class="kill-btn" onclick="killSwitch()">KILL SWITCH</button>
                <div class="status-badge online" id="status-badge">
                    <div class="pulse"></div>
                    <span id="status-text">LOADING...</span>
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-header">Portfolio Value</div>
                <div class="card-value green" id="portfolio-value">--</div>
                <div class="card-sub">Paper trading account</div>
            </div>

            <div class="card">
                <div class="card-header">Today's P&L</div>
                <div class="card-value" id="daily-pnl">$0.00</div>
                <div class="card-sub">No trades yet</div>
            </div>

            <div class="card">
                <div class="card-header">Trading Mode</div>
                <div class="card-value orange" id="trading-mode">--</div>
                <div class="card-sub">Safe mode active</div>
            </div>

            <div class="card">
                <div class="card-header">Open Positions</div>
                <div class="card-value blue" id="positions-count">0</div>
                <div class="card-sub">Max $100 per position</div>
            </div>

            <div class="card trade-card">
                <div class="card-header">Trade</div>
                <div class="trade-form">
                    <div>
                        <label>Symbol</label>
                        <select id="trade-symbol">
                            <option value="BTC">BTC</option>
                            <option value="ETH">ETH</option>
                            <option value="SOL">SOL</option>
                        </select>
                    </div>
                    <div>
                        <label>Amount (AUD)</label>
                        <input type="number" id="trade-amount" value="50" min="10" max="100" step="10">
                    </div>
                    <div>
                        <label>Stop Loss %</label>
                        <input type="number" id="trade-sl-pct" value="5" min="1" max="20" step="1">
                    </div>
                    <div>
                        <label>Strategy</label>
                        <select id="trade-strategy">
                            <option value="manual">Manual</option>
                            <option value="momentum">Momentum</option>
                            <option value="meanrev">Mean Reversion</option>
                        </select>
                    </div>
                </div>
                <div class="trade-actions">
                    <button class="btn-buy" onclick="placeTrade('buy')">BUY</button>
                    <button class="btn-sell" onclick="placeTrade('sell')">SELL</button>
                </div>
                <div class="trade-result" id="trade-result"></div>
            </div>

            <div class="card trade-card">
                <div class="card-header">Open Positions</div>
                <table class="positions-table" id="positions-table">
                    <thead>
                        <tr>
                            <th>Symbol</th>
                            <th>Side</th>
                            <th>Entry</th>
                            <th>Current</th>
                            <th>Stop Loss</th>
                            <th>Size</th>
                            <th>P&L</th>
                        </tr>
                    </thead>
                    <tbody id="positions-body">
                        <tr><td colspan="7" style="color:#484f58; text-align:center;">No open positions</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card prices-card">
                <div class="card-header">
                    Live Prices
                    <span id="prices-status" style="font-size:11px; color:#484f58; text-transform:none; letter-spacing:0;"> -- loading</span>
                </div>
                <div class="price-grid" id="price-grid"></div>
                <div id="price-errors"></div>
            </div>

            <div class="card chart-card">
                <div class="card-header">Chart</div>
                <div class="chart-controls">
                    <select id="chart-symbol">
                        <option value="BTC">BTC</option>
                        <option value="ETH">ETH</option>
                        <option value="SOL">SOL</option>
                        <option value="BHP.AX">BHP.AX</option>
                        <option value="CBA.AX">CBA.AX</option>
                        <option value="CSL.AX">CSL.AX</option>
                        <option value="SPY">SPY</option>
                        <option value="AAPL">AAPL</option>
                        <option value="NVDA">NVDA</option>
                    </select>
                    <button class="tf-btn active" data-tf="1h" onclick="setTimeframe('1h', this)">1H</button>
                    <button class="tf-btn" data-tf="4h" onclick="setTimeframe('4h', this)">4H</button>
                    <button class="tf-btn" data-tf="1d" onclick="setTimeframe('1d', this)">1D</button>
                    <span id="chart-info" style="font-size:11px; color:#484f58; margin-left:auto;"></span>
                </div>
                <div id="chart-container"></div>
            </div>

            <div class="card markets-card">
                <div class="card-header">Market Sessions <span id="session-time" style="font-size:11px; color:#484f58; text-transform:none; letter-spacing:0;"></span></div>
                <div class="session-grid" id="session-grid">
                    <div class="session-card">
                        <div class="session-market">ASX</div>
                        <div class="session-badge closed">Loading...</div>
                    </div>
                    <div class="session-card">
                        <div class="session-market">US</div>
                        <div class="session-badge closed">Loading...</div>
                    </div>
                    <div class="session-card">
                        <div class="session-market">Crypto</div>
                        <div class="session-badge open">24/7</div>
                    </div>
                </div>
            </div>

            <div class="card markets-card">
                <div class="card-header">Data Health <span id="dq-status" style="font-size:11px; color:#484f58; text-transform:none; letter-spacing:0;"></span></div>
                <div class="health-summary" id="health-summary"></div>
                <div class="health-grid" id="health-grid">
                    <div class="health-item">
                        <span class="health-label">Loading data quality checks...</span>
                    </div>
                </div>
            </div>

            <div class="card log-card">
                <div class="card-header">System Log</div>
                <div class="log-entries" id="log-entries">
                    <div class="log-entry">
                        <span class="log-time">--:--:--</span>
                        <span class="log-level info">INFO</span>
                        <span class="log-msg">Connecting to FlashTrade API...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <span>FlashTrade v0.5.0 &mdash; Day 5 of 30</span>
            <span>
                <a href="https://github.com/HallyAus/FlashTrade" target="_blank">GitHub</a>
                &nbsp;&middot;&nbsp;
                <a href="https://printforge.com.au" target="_blank">Printforge</a>
            </span>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function timeNow() {
            return new Date().toLocaleTimeString('en-AU', {
                hour12: false,
                timeZone: 'Australia/Sydney'
            });
        }

        function addLog(level, msg) {
            const entries = document.getElementById('log-entries');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-time">${timeNow()}</span>
                <span class="log-level ${level}">${level.toUpperCase()}</span>
                <span class="log-msg">${msg}</span>
            `;
            entries.appendChild(entry);
            // Keep last 10 entries
            while (entries.children.length > 10) {
                entries.removeChild(entries.firstChild);
            }
        }

        async function fetchStatus() {
            try {
                const [root, portfolio, admin] = await Promise.all([
                    fetch(`${API_BASE}/api`).then(r => r.json()),
                    fetch(`${API_BASE}/api/dashboard/portfolio`).then(r => r.json()),
                    fetch(`${API_BASE}/api/admin/status`).then(r => r.json()),
                ]);

                // Update status badge
                const badge = document.getElementById('status-badge');
                const statusText = document.getElementById('status-text');
                if (admin.halted) {
                    badge.className = 'status-badge offline';
                    statusText.textContent = 'HALTED';
                    badge.querySelector('.pulse').style.background = '#f85149';
                } else {
                    badge.className = 'status-badge online';
                    statusText.textContent = 'ONLINE';
                    badge.querySelector('.pulse').style.background = '#3fb950';
                }

                // Update cards
                const value = portfolio.portfolio_value_cents / 100;
                document.getElementById('portfolio-value').textContent =
                    '$' + value.toLocaleString('en-AU', { minimumFractionDigits: 2 });

                const pnl = portfolio.daily_pnl_cents / 100;
                const pnlEl = document.getElementById('daily-pnl');
                pnlEl.textContent = (pnl >= 0 ? '+' : '') + '$' + pnl.toFixed(2);
                pnlEl.className = 'card-value ' + (pnl >= 0 ? 'green' : 'red');

                document.getElementById('trading-mode').textContent =
                    root.trading_mode.toUpperCase();
                document.getElementById('positions-count').textContent =
                    portfolio.positions.length;

                addLog('ok', `System healthy | Mode: ${root.trading_mode} | Portfolio: $${value.toFixed(2)}`);
            } catch (err) {
                document.getElementById('status-text').textContent = 'OFFLINE';
                document.getElementById('status-badge').className = 'status-badge offline';
                addLog('warn', `API unreachable: ${err.message}`);
            }
        }

        async function killSwitch() {
            if (!confirm('KILL SWITCH: This will halt ALL trading immediately. Are you sure?')) return;
            try {
                const res = await fetch(`${API_BASE}/api/admin/kill-switch`, { method: 'POST' });
                const data = await res.json();
                addLog('warn', `KILL SWITCH ACTIVATED: ${data.message}`);
                fetchStatus();
            } catch (err) {
                addLog('warn', `Kill switch failed: ${err.message}`);
            }
        }

        function formatPrice(cents, currency) {
            const dollars = cents / 100;
            const sym = currency === 'AUD' ? 'A$' : '$';
            if (dollars >= 1000) {
                return sym + dollars.toLocaleString('en-AU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            return sym + dollars.toFixed(2);
        }

        function renderPriceCard(item, type) {
            const changePct = type === 'crypto' ? item.change_24h_pct : item.change_pct;
            const changeClass = changePct > 0 ? 'up' : changePct < 0 ? 'down' : 'flat';
            const delayTag = item.delayed ? ' (15m delay)' : '';
            const changeLabel = type === 'crypto' ? '24h' : 'day';
            const sign = changePct >= 0 ? '+' : '';
            return `
                <div class="price-card">
                    <div class="price-symbol">
                        ${item.symbol}
                        <span class="price-tag ${item.market}">${item.market}</span>
                    </div>
                    <div class="price-value">${formatPrice(item.price_cents, item.currency)}</div>
                    <div class="price-change ${changeClass}">${sign}${changePct.toFixed(2)}% ${changeLabel}</div>
                    <div class="price-meta">${item.currency}${delayTag}</div>
                </div>
            `;
        }

        async function fetchPrices() {
            try {
                const data = await fetch(`${API_BASE}/api/dashboard/prices`).then(r => r.json());
                const grid = document.getElementById('price-grid');
                const errDiv = document.getElementById('price-errors');
                const status = document.getElementById('prices-status');

                let html = '';
                for (const item of (data.crypto || [])) html += renderPriceCard(item, 'crypto');
                for (const item of (data.stocks || [])) html += renderPriceCard(item, 'stock');

                grid.innerHTML = html || '<div class="price-meta">No price data available</div>';

                if (data.errors && data.errors.length > 0) {
                    errDiv.innerHTML = data.errors.map(e =>
                        `<div class="price-error">${e.source}: ${e.error}</div>`
                    ).join('');
                } else {
                    errDiv.innerHTML = '';
                }

                const t = new Date(data.fetched_at_utc);
                status.textContent = ' -- updated ' + t.toLocaleTimeString('en-AU', { hour12: false, timeZone: 'Australia/Sydney' }) + ' AEST';

                // Cache prices for trade form
                for (const item of (data.crypto || [])) latestPrices[item.symbol] = item.price_cents;
                for (const item of (data.stocks || [])) latestPrices[item.symbol] = item.price_cents;

                const cc = (data.crypto || []).length;
                const sc = (data.stocks || []).length;
                addLog('info', `Prices: ${cc} crypto, ${sc} stocks`);
            } catch (err) {
                document.getElementById('prices-status').textContent = ' -- error';
                addLog('warn', `Price fetch failed: ${err.message}`);
            }
        }

        // ---- Trading ----
        let latestPrices = {};

        async function placeTrade(side) {
            const symbol = document.getElementById('trade-symbol').value;
            const amountAud = parseFloat(document.getElementById('trade-amount').value);
            const slPct = parseFloat(document.getElementById('trade-sl-pct').value);
            const strategy = document.getElementById('trade-strategy').value;

            // Get current price from cache
            const priceCents = latestPrices[symbol] || 0;
            if (!priceCents) {
                showTradeResult('error', 'No price available for ' + symbol + '. Wait for prices to load.');
                return;
            }

            const quantityCents = Math.round(amountAud * 100);
            const stopLossCents = side === 'buy'
                ? Math.round(priceCents * (1 - slPct / 100))
                : Math.round(priceCents * (1 + slPct / 100));

            const conf = `${side.toUpperCase()} ${symbol}\nAmount: A$${amountAud}\nPrice: A$${(priceCents/100).toFixed(2)}\nStop Loss: A$${(stopLossCents/100).toFixed(2)} (${slPct}%)`;
            if (!confirm(conf)) return;

            try {
                const resp = await fetch(`${API_BASE}/api/trades/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        symbol: symbol,
                        market: 'crypto',
                        side: side,
                        order_type: 'market',
                        quantity_cents: quantityCents,
                        price_cents: priceCents,
                        stop_loss_cents: stopLossCents,
                        strategy: strategy,
                        reason: `Manual ${side} via dashboard`,
                    }),
                });
                const data = await resp.json();

                if (data.status === 'filled') {
                    showTradeResult('success', `${side.toUpperCase()} ${symbol} filled — Trade #${data.trade_id}`);
                    addLog('ok', `Trade filled: ${side} ${symbol} A$${amountAud}`);
                    fetchPositions();
                    fetchStatus();
                } else {
                    showTradeResult('error', `Rejected: ${data.reason}`);
                    addLog('warn', `Trade rejected: ${data.reason}`);
                }
            } catch (err) {
                showTradeResult('error', `Trade failed: ${err.message}`);
            }
        }

        function showTradeResult(type, msg) {
            const el = document.getElementById('trade-result');
            el.className = 'trade-result ' + type;
            el.textContent = msg;
            setTimeout(() => { el.className = 'trade-result'; }, 8000);
        }

        async function fetchPositions() {
            try {
                const data = await fetch(`${API_BASE}/api/trades/positions`).then(r => r.json());
                const body = document.getElementById('positions-body');
                const positions = data.positions || [];

                if (positions.length === 0) {
                    body.innerHTML = '<tr><td colspan="7" style="color:#484f58; text-align:center;">No open positions</td></tr>';
                    document.getElementById('positions-count').textContent = '0';
                    return;
                }

                document.getElementById('positions-count').textContent = positions.length;

                body.innerHTML = positions.map(p => {
                    const entry = (p.entry_price_cents / 100).toFixed(2);
                    const current = (p.current_price_cents / 100).toFixed(2);
                    const sl = (p.stop_loss_cents / 100).toFixed(2);
                    const size = (p.quantity / 100).toFixed(2);
                    const pnl = (p.unrealized_pnl_cents / 100).toFixed(2);
                    const pnlClass = p.unrealized_pnl_cents >= 0 ? 'pnl-positive' : 'pnl-negative';
                    const pnlSign = p.unrealized_pnl_cents >= 0 ? '+' : '';
                    return `<tr>
                        <td><strong>${p.symbol}</strong></td>
                        <td>${p.side}</td>
                        <td>A$${entry}</td>
                        <td>A$${current}</td>
                        <td>A$${sl}</td>
                        <td>A$${size}</td>
                        <td class="${pnlClass}">${pnlSign}A$${pnl}</td>
                    </tr>`;
                }).join('');
            } catch (err) {
                // Silently fail — positions table stays as-is
            }
        }

        // ---- Chart ----
        let chart = null;
        let candleSeries = null;
        let volumeSeries = null;
        let currentTF = '1h';

        function initChart() {
            const container = document.getElementById('chart-container');
            chart = LightweightCharts.createChart(container, {
                layout: {
                    background: { color: '#0d1117' },
                    textColor: '#8b949e',
                },
                grid: {
                    vertLines: { color: '#1e2836' },
                    horzLines: { color: '#1e2836' },
                },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderColor: '#21262d' },
                timeScale: {
                    borderColor: '#21262d',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });

            candleSeries = chart.addCandlestickSeries({
                upColor: '#3fb950',
                downColor: '#f85149',
                borderDownColor: '#f85149',
                borderUpColor: '#3fb950',
                wickDownColor: '#f85149',
                wickUpColor: '#3fb950',
            });

            volumeSeries = chart.addHistogramSeries({
                priceFormat: { type: 'volume' },
                priceScaleId: '',
            });
            volumeSeries.priceScale().applyOptions({
                scaleMargins: { top: 0.8, bottom: 0 },
            });

            // Resize on window resize
            new ResizeObserver(() => {
                chart.applyOptions({ width: container.clientWidth });
            }).observe(container);
        }

        async function loadChart() {
            const symbol = document.getElementById('chart-symbol').value;
            const days = currentTF === '1d' ? 180 : currentTF === '4h' ? 90 : 30;

            try {
                const data = await fetch(
                    `${API_BASE}/api/dashboard/chart?symbol=${symbol}&timeframe=${currentTF}&days=${days}`
                ).then(r => r.json());

                const candles = data.candles || [];
                if (candles.length === 0) {
                    document.getElementById('chart-info').textContent = 'No data for this selection';
                    return;
                }

                candleSeries.setData(candles.map(c => ({
                    time: c.time,
                    open: c.open,
                    high: c.high,
                    low: c.low,
                    close: c.close,
                })));

                volumeSeries.setData(candles.map(c => ({
                    time: c.time,
                    value: c.volume,
                    color: c.close >= c.open ? 'rgba(63,185,80,0.3)' : 'rgba(248,81,73,0.3)',
                })));

                chart.timeScale().fitContent();
                document.getElementById('chart-info').textContent =
                    `${data.count} candles · ${symbol} ${currentTF}`;
            } catch (err) {
                document.getElementById('chart-info').textContent = 'Chart load failed';
            }
        }

        function setTimeframe(tf, btn) {
            currentTF = tf;
            document.querySelectorAll('.tf-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            loadChart();
        }

        document.getElementById('chart-symbol').addEventListener('change', loadChart);

        async function fetchMarketStatus() {
            try {
                const data = await fetch(`${API_BASE}/api/dashboard/market-status`).then(r => r.json());
                const grid = document.getElementById('session-grid');

                const labels = { asx: 'ASX', us: 'US Stocks', crypto: 'Crypto' };
                const brokers = { asx: 'Signals Only', us: 'Alpaca', crypto: 'Swyftx' };

                let html = '';
                for (const m of (data.markets || [])) {
                    const badge = m.is_open
                        ? '<span class="session-badge open">OPEN</span>'
                        : '<span class="session-badge closed">CLOSED</span>';

                    let detail = m.local_time;
                    if (m.closes_in_minutes) {
                        const h = Math.floor(m.closes_in_minutes / 60);
                        const mins = m.closes_in_minutes % 60;
                        detail += ` · closes in ${h}h ${mins}m`;
                    } else if (m.opens_in_minutes) {
                        const h = Math.floor(m.opens_in_minutes / 60);
                        const mins = m.opens_in_minutes % 60;
                        detail += ` · opens in ${h}h ${mins}m`;
                    }

                    html += `
                        <div class="session-card">
                            <div class="session-market">${labels[m.market] || m.market}</div>
                            ${badge}
                            <div class="session-detail">${detail}</div>
                            <div class="session-detail">${brokers[m.market] || ''}</div>
                        </div>
                    `;
                }
                grid.innerHTML = html;
            } catch (err) {
                addLog('warn', `Market status fetch failed: ${err.message}`);
            }
        }

        async function fetchDataQuality() {
            try {
                const data = await fetch(`${API_BASE}/api/dashboard/data-quality`).then(r => r.json());
                const grid = document.getElementById('health-grid');
                const summary = document.getElementById('health-summary');
                const status = document.getElementById('dq-status');

                if (data.error) {
                    grid.innerHTML = `<div class="health-item"><span class="health-label">Error: ${data.error}</span></div>`;
                    return;
                }

                // Summary line
                const issues = data.total_issues || 0;
                const errors = data.errors || 0;
                const warnings = data.warnings || 0;
                const symbols = (data.symbols || []).length;

                let summaryClass = 'ok';
                if (errors > 0) summaryClass = 'error';
                else if (warnings > 0) summaryClass = 'warn';

                summary.innerHTML = `
                    <span>${symbols} feeds checked</span>
                    <span class="health-stat ${summaryClass}">${issues === 0 ? 'All healthy' : `${errors} errors, ${warnings} warnings`}</span>
                `;

                const t = new Date(data.checked_at_utc);
                status.textContent = ' -- checked ' + t.toLocaleTimeString('en-AU', { hour12: false, timeZone: 'Australia/Sydney' }) + ' AEST';

                // Per-symbol items
                let html = '';
                for (const s of (data.symbols || [])) {
                    const staleClass = s.staleness_minutes > 60 ? 'warn' : 'ok';
                    const missingClass = s.missing_pct > 5 ? 'warn' : 'ok';
                    const issueCount = (s.issues || []).length;
                    const statusClass = issueCount > 0 ? (s.issues.some(i => i.severity === 'error') ? 'error' : 'warn') : 'ok';
                    const statusLabel = issueCount > 0 ? `${issueCount} issue${issueCount > 1 ? 's' : ''}` : 'OK';

                    html += `
                        <div class="health-item">
                            <div class="health-label">
                                ${s.symbol} <small>${s.timeframe}</small><br>
                                <small>${s.total_rows.toLocaleString()} rows · ${s.staleness_minutes}m ago</small>
                            </div>
                            <span class="health-stat ${statusClass}">${statusLabel}</span>
                        </div>
                    `;
                }
                grid.innerHTML = html || '<div class="health-item"><span class="health-label">No data yet — run backfill first</span></div>';
            } catch (err) {
                addLog('warn', `Data quality fetch failed: ${err.message}`);
            }
        }

        // Initial fetch
        document.getElementById('log-entries').innerHTML = '';
        addLog('info', 'FlashTrade dashboard loaded');
        initChart();
        loadChart();
        fetchStatus();
        fetchPrices();
        fetchPositions();
        fetchMarketStatus();
        fetchDataQuality();

        // Poll every 30 seconds
        setInterval(fetchStatus, 30000);
        setInterval(fetchPrices, 30000);
        setInterval(fetchPositions, 15000);
        setInterval(fetchMarketStatus, 60000);
        setInterval(fetchDataQuality, 300000); // every 5 min
    </script>
</body>
</html>
